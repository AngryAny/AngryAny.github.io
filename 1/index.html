<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Colorization with OpenCV</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
        }
        
        p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .image-container {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .image-caption {
            margin-top: 10px;
            font-style: italic;
            color: #666;
            font-size: 14px;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .gallery-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .gallery-item img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }
        
        .intro {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <h1>Image Colorization with OpenCV</h1>
    
    <div class="intro">
        <p>This blog explores how to use OpenCV to colorize grayscale images. Before the advent of color cameras, photographers captured images of each RGB channel separately to reconstruct the final color image.</p>
    </div>

    <p>I will use the following image as an example:</p>

    <div class="image-container">
        <img src="media/cathedral.jpg" alt="Cathedral original grayscale channels">
        <div class="image-caption">Original Cathedral image with separate R, G, B channels</div>
    </div>

    <p>This image is a grayscale image (only one channel instead of RGB), with each of the 3 sections representing the blue, green, and red channels in grayscale. Our job is to combine these three grayscales to create a color image.</p>

    <p>A naive attempt at this will look something like this:</p>

    <div class="image-container">
        <img src="media/cathedral_0.jpg" alt="Cathedral naive alignment">
        <div class="image-caption">Naive alignment - simply stacking the channels without proper alignment</div>
    </div>

    <p>What we do here is naively chunk the original image into thirds by height and assign the colors respectively. We can see that the images do not align properly.</p>

    <p>Thus, we need to align the three images together to get the correct color image. An easy way to start is to find the alignment that reduces the L2 loss, since we know that these colors will generally have high correlation.</p>

    <p>Of course, a natural problem that arises here is that after adding some sort of offset, the image dimensions will no longer match up. Thus, we need to find a way to account for this in our norm. One way to do this is to apply the L2 norm on a smaller patch of the image such that both the original and shifted dimensions include the entirety of this smaller patch. I arbitrarily chose the middle 40% of each dimension (meaning we only use 16% total).</p>

    <p>Applying this technique to our image, we get the following output:</p>

    <div class="image-container">
        <img src="media/cathedral_1_L2.jpg" alt="Cathedral L2 alignment">
        <div class="image-caption">L2 loss alignment result</div>
    </div>

    <p>Another way to do this is to use the Normalized Cross Correlation (NCC) loss. The output looks as follows:</p>

    <div class="image-container">
        <img src="media/cathedral_1_ncc.jpg" alt="Cathedral NCC alignment">
        <div class="image-caption">Normalized Cross Correlation (NCC) alignment result</div>
    </div>

    <h2>Pyramid Search Algorithm</h2>

    <p>The problem here is that although this works on a smaller image like this (~300 x 300 pixels), trying to brute force search this on every pixel will take too much time. Thus, we want to implement a pyramid-based search to find the best alignment.</p>

    <p>A pyramid-based search starts with a much lower resolution version of the image (downsampled) and finds the best offset for this smaller version. Then, we look at a larger version of it, find an offset (based on the offset of the smaller version) and repeat this process until we reach the original resolution.</p>

    <p>In this particular case, the pyramid search results in the same output without any significant speed up. However, consider a different image such as this image of 3 generations:</p>

    <div class="image-container">
        <img src="media/three_generations.jpg" alt="3 Generations original">
        <div class="image-caption">Three Generations - original grayscale channels (9629 x 3714 pixels)</div>
    </div>

    <p>This image is 9629 x 3714 pixels. If we were to use the brute force approach, we would have to search tens of millions of possible alignments, taking minutes if not hours. On the other hand, the pyramid search only takes a few seconds under the right conditions.</p>

    <p>Here is the output of the pyramid search:</p>

    <div class="image-container">
        <img src="media/three_generations_aligned_pyramid.jpg" alt="3 Generations pyramid result">
        <div class="image-caption">Three Generations - pyramid search result</div>
    </div>

    <h2>Gallery of Pyramid Search Results</h2>
    
    <p>Here are the results of the pyramid search algorithm applied to various other images:</p>

    <div class="gallery">
        <div class="gallery-item">
            <img src="media/monastery_aligned_pyramid.jpg" alt="Monastery">
            <div class="image-caption">Monastery</div>
        </div>

        <div class="gallery-item">
            <img src="media/tobolsk_aligned_pyramid.jpg" alt="Tobolsk">
            <div class="image-caption">Tobolsk</div>
        </div>

        <div class="gallery-item">
            <img src="media/cathedral_aligned_pyramid.jpg" alt="Cathedral">
            <div class="image-caption">Cathedral</div>
        </div>

        <div class="gallery-item">
            <img src="media/emir_aligned_pyramid.jpg" alt="Emir">
            <div class="image-caption">Emir</div>
        </div>

        <div class="gallery-item">
            <img src="media/italil_aligned_pyramid.jpg" alt="Italil">
            <div class="image-caption">Italil</div>
        </div>

        <div class="gallery-item">
            <img src="media/church_aligned_pyramid.jpg" alt="Church">
            <div class="image-caption">Church</div>
        </div>

        <div class="gallery-item">
            <img src="media/lugano_aligned_pyramid.jpg" alt="Lugano">
            <div class="image-caption">Lugano</div>
        </div>

        <div class="gallery-item">
            <img src="media/melons_aligned_pyramid.jpg" alt="Melons">
            <div class="image-caption">Melons</div>
        </div>

        <div class="gallery-item">
            <img src="media/lastochikino_aligned_pyramid.jpg" alt="Lastochikino">
            <div class="image-caption">Lastochikino</div>
        </div>

        <div class="gallery-item">
            <img src="media/icon_aligned_pyramid.jpg" alt="Icon">
            <div class="image-caption">Icon</div>
        </div>

        <div class="gallery-item">
            <img src="media/siren_aligned_pyramid.jpg" alt="Siren">
            <div class="image-caption">Siren</div>
        </div>

        <div class="gallery-item">
            <img src="media/self_portrait_aligned_pyramid.jpg" alt="Self Portrait">
            <div class="image-caption">Self Portrait</div>
        </div>

        <div class="gallery-item">
            <img src="media/harvesters_aligned_pyramid.jpg" alt="Harvesters">
            <div class="image-caption">Harvesters</div>
        </div>
    </div>

</body>
</html>